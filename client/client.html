<!DOCTYPE html>
<html lang="en">
<head>
  <title>Books API Test App</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script>
    //Handles our FETCH response. This function is async because it
    //contains an await.
    const handleResponse = async (response, parseResponse = true) => {
      //Grab the content section
      const content = document.querySelector('#content');

      //Based on the status code, display something
      switch(response.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Created</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }


      if(parseResponse) {
        //Parse the response to json. This works because we know the server always
        //sends back json. Await because .json() is an async function.
        const obj = await response.json();
        
        //If we have a message, display it.
        if(obj.message){
          content.innerHTML += `<p>${obj.message}</p>`;
        }
        if(obj.books) {
          // Display the books, but shorten the result to only 300 chars
          content.innerHTML += `<p>${JSON.stringify(obj.books).substring(0, 300) + '...'}</p>`;
        }
      }
    };

    //Uses fetch to send a postRequest. Marksed as async because we use await
    //within it.
    const sendPost = async (nameForm) => {
      //Grab all the info from the form
      const url = nameForm.getAttribute('action');
      const method = nameForm.getAttribute('method');
      
      const nameField = nameForm.querySelector('#nameField');
      const ageField = nameForm.querySelector('#ageField');

      //Build a data string in the FORM-URLENCODED format.
      const formData = `name=${nameField.value}&age=${ageField.value}`;

      //Make a fetch request and await a response. Set the method to
      //the one provided by the form (POST). Set the headers. Content-Type
      //is the type of data we are sending. Accept is the data we would like
      //in response. Then add our FORM-URLENCODED string as the body of the request.
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      });

      //Once we have a response, handle it.
      handleResponse(response);
    };

    //Uses fetch to send a postRequest. Marksed as async because we use await
    //within it.
    const sendPostBook = async (addBookForm) => {
      //Grab all the info from the form
      const url = addBookForm.getAttribute('action');
      const method = addBookForm.getAttribute('method');
      
      const authorField = addBookForm.querySelector('#authorField');
      const countryField = addBookForm.querySelector('#countryField');
      const languageField = addBookForm.querySelector('#languageField');
      const linkField = addBookForm.querySelector('#linkField');
      const pagesField = addBookForm.querySelector('#pagesField');
      const titleField = addBookForm.querySelector('#titleField');
      const yearField = addBookForm.querySelector('#yearField');
      const genre1Field = addBookForm.querySelector('#genre1Field');
      const genre2Field = addBookForm.querySelector('#genre2Field');

      //Build a data string in the FORM-URLENCODED format.
      const formData = `author=${authorField.value}` + 
                       `&country=${countryField.value}` +  
                       `&language=${languageField.value}` +  
                       `&link=${linkField.value}` +  
                       `&pages=${pagesField.value}` +  
                       `&title=${titleField.value}` +  
                       `&year=${yearField.value}` +  
                       `&genre1=${genre1Field.value}` +
                       `&genre2=${genre2Field.value}`;

      //Make a fetch request and await a response. Set the method to
      //the one provided by the form (POST). Set the headers. Content-Type
      //is the type of data we are sending. Accept is the data we would like
      //in response. Then add our FORM-URLENCODED string as the body of the request.
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      })

      //Once we have a response, handle it.
      handleResponse(response);
    };

    const sendFetchRequest = async (form) => {
      const url = form.querySelector('#urlField').value;
      const method = form.querySelector('#methodSelect').value;

      const response = await fetch(url, {
        method,
        headers: {
          'Accept': 'application/json',
        },
      });

      handleResponse(response, method === 'get');
    };

    const sendAllBooksFetchRequest = async (form) => {
      const url = form.getAttribute('action');
      const method = form.querySelector('#methodSelect').value;

      const response = await fetch(url, {
        method,
        headers: {
          'Accept': 'application/json',
        },
      });

      handleResponse(response, method === 'get');
    };

    //Init function is called when window.onload runs (set below).
    const init = () => {
      //Grab the forms
      const addBookForm = document.querySelector('#addBookForm');

      const getAllBooksForm = document.querySelector('#getAllBooksForm');

      // Create addBook function that cancels the form's default action
      // and calls our sendPostBook function above.
      const addBook = (e) => {
        e.preventDefault();
        sendPostBook(addBookForm);
        return false;
      }

      const sendAllBooks = (e) => {
        e.preventDefault();
        sendAllBooksFetchRequest(getAllBooksForm);
        return false;
      }

      // Call functions when the submit event fires on the form.
      addBookForm.addEventListener('submit', addBook);

      getAllBooksForm.addEventListener('submit', sendAllBooks)
    };

    //When the window loads, run init.
    window.onload = init;
  </script>
</head>
<body>
  <section id="top">
    <h1>Books API Test App</h1>
    <hr>
    </section>
    <section id="content">
    </section>
    <hr>

    <form id="addBookForm" action="/addBook" method="post">
      <h3>Add a new book</h3>
      <label for="author">Author: </label>
      <input id="authorField" type="text" name="author" />
      <br>
      <label for="country">Country: </label>
      <input id="countryField" type="text" name="country" />
      <br>
      <label for="language">Language: </label>
      <input id="languageField" type="text" name="language" />
      <br>
      <label for="link">Link: </label>
      <input id="linkField" type="text" name="link" />
      <br>
      <label for="pages">Pages: </label>
      <input id="pagesField" type="number" name="pages" />
      <br>
      <label for="title">Title: </label>
      <input id="titleField" type="text" name="title" />
      <br>
      <label for="year">Year: </label>
      <input id="yearField" type="number" name="year" />
      <br>
      <label for="genres">Genres: </label>
      <input id="genre1Field" type="text" name="genre1" />
      <input id="genre2Field" type="text" name="genre2" />
      <br>
      <input type="submit" value="Add Book" />
    </form>
    <hr>

    <form id="addBookReview" action="/addBookReview" method="post">
      <h3>Add a new book review</h3>
      <label for="title">Title: </label>
      <input id="titleField" type="text" name="title" />
      <br>
      <label for="rating">Rating: </label>
      <input id="ratingField" type="number" name="rating" min="1" max="5" step="1"/>
      <br>
      <input type="submit" value="Add Book Review" />
    </form>
    <hr>

    <form id="getAllBooksForm" action="/getAllBooks" method="get">
      <h3>Test retrieving all books</h3>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <br>
      <input type="submit" value="Get All Books" />
    </form>
    <hr>

    <form id="getBookByTitleForm" action="/getBookByTitle" method="get">
      <h3>Test retrieving a book by title</h3>
      <label for="title">Title: </label>
      <input id="titleField" type="text" name="title" />
      <br>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <br>
      <input type="submit" value="Get Book By Title" />
    </form>
    <hr>

    <form id="getBooksByAuthorForm" action="/getBooksByAuthor" method="get">
      <h3>Test retrieving books by author</h3>
      <label for="author">Author: </label>
      <input id="authorField" type="text" name="author" />
      <br>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <br>
      <input type="submit" value="Get Books By Author" />
    </form>
    <hr>

    <form id="getBooksByLanguageForm" action="/getBooksByLanguage" method="get">
      <h3>Test retrieving books by language</h3>
      <label for="language">Language: </label>
      <input id="language" type="text" name="language" />
      <br>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <br>
      <input type="submit" value="Get Books By Language" />
    </form>
    <hr><br>
</body>
</html>
